<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotadrez - Edición Definitiva</title>
    <style>
        :root { --c-red: #e74c3c; --c-black: #2c3e50; --c-board-l: #f0d9b5; --c-board-d: #b58863; }
        body { background-color: #1a252f; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .main-container { display: flex; gap: 20px; align-items: flex-start; position: relative; }
        .panel { width: 220px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; border: 2px solid #444; height: 600px; display: flex; flex-direction: column; transition: opacity 0.3s; }
        .panel.active { border-color: #f1c40f; box-shadow: 0 0 15px rgba(241, 196, 15, 0.2); opacity: 1; }
        .panel.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        
        /* Tablero */
        #board { display: grid; grid-template-columns: repeat(10, 60px); grid-template-rows: repeat(10, 60px); border: 10px solid #34495e; position: relative; background-color: #2c3e50; }
        .tile { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; position: relative; box-sizing: border-box; }
        .light { background-color: var(--c-board-l); }
        .dark { background-color: var(--c-board-d); }
        .water { background-color: #3498db !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        
        /* Imágenes */
        .piece { width: 90%; height: 90%; z-index: 10; cursor: grab; transition: transform 0.1s; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4)); }
        .piece:active { cursor: grabbing; transform: scale(1.1); }
        
        /* Estructuras */
        .structure-img { width: 100%; height: 100%; z-index: 5; opacity: 1.0; pointer-events: none; }
        .fortress-part { width: 100%; height: 100%; z-index: 4; }
        
        /* Animación de "Click para terminar" */
        .deploy-clickable { cursor: pointer !important; outline: 3px solid #f1c40f; outline-offset: -3px; animation: pulse 1.5s infinite; z-index: 20; pointer-events: auto !important; }
        
        /* GHOSTING (Feedback Visual) */
        .ghost-valid { background-color: rgba(46, 204, 113, 0.6) !important; box-shadow: inset 0 0 0 2px #27ae60; }
        .ghost-invalid { background-color: rgba(231, 76, 60, 0.6) !important; box-shadow: inset 0 0 0 2px #c0392b; }

        /* Inventario */
        .inv-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; overflow-y: auto; flex: 1; }
        .inv-item { width: 50px; height: 50px; background: rgba(255,255,255,0.1); border-radius: 5px; position: relative; cursor: grab; display: flex; justify-content: center; align-items: center; }
        .inv-item .count { position: absolute; top: 0; right: 0; background: red; font-size: 10px; padding: 2px 5px; border-radius: 50%; }
        .inv-item.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .inv-item img { pointer-events: none; width: 80%; height: 80%; }

        /* Cortina */
        #curtain { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:#2c3e50; z-index:100; flex-direction:column; align-items:center; justify-content:center; }
        #curtain h1 { color: #f1c40f; }
        button { padding: 10px 20px; font-size: 1.2em; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 5px;}
        
        @keyframes pulse { 0% { outline-color: #f1c40f; } 50% { outline-color: rgba(241, 196, 15, 0); } 100% { outline-color: #f1c40f; } }
    </style>
</head>
<body>

    <div id="status-bar" style="margin-bottom: 10px; font-size: 1.3em; color: #f1c40f; text-align: center; height: 40px; font-weight: bold;">Cargando...</div>

    <div class="main-container">
        <div class="panel" id="panel-rojo">
            <h3 style="color:#e74c3c; text-align:center; margin:0;">ROJO</h3>
            <div class="inv-list" id="inv-rojo"></div>
        </div>

        <div id="board"></div>

        <div class="panel" id="panel-negro">
            <h3 style="color:#bdc3c7; text-align:center; margin:0;">NEGRO</h3>
            <div class="inv-list" id="inv-negro"></div>
        </div>
        
        <div id="curtain">
            <h1>TELÓN DE ACERO</h1>
            <p>Jugador 1 ha terminado. Turno del Jugador 2.</p>
            <button onclick="startPhase2()">Comenzar Despliegue J2</button>
        </div>
    </div>

<script>
// CONFIGURACIÓN
const CONFIG = {
    repo: "https://cdn.jsdelivr.net/gh/mcuervo-web/Cotadrez@main",
    pieces: {
        'fortaleza': { qty: 1, size: 2 }, 'montana': { qty: 3, size: 1 },
        'rey': { qty: 1 }, 'chusma': { qty: 3 }, 'lanceros': { qty: 3 },
        'arqueros': { qty: 3 }, 'c_ligera': { qty: 3 }, 'c_pesada': { qty: 2 },
        'elefante': { qty: 2 }, 'escorpion': { qty: 1 }, 'trabuquete': { qty: 1 },
        'dragon': { qty: 1 }
    }
};

// ESTADO
let gameState = 'choose-color';
let board = Array(10).fill().map(() => Array(10).fill(null)); 
let terrain = Array(10).fill().map(() => Array(10).fill(null)); 
let fortresses = { rojo: null, negro: null }; 
let reserves = { rojo: {}, negro: {} };
let mazmorra = { rojo: [], negro: [] }; 
let turn = null; 
let p1Color = null; 
let chusmaState = { movedCount: 0, lastId: null };
let draggingMeta = null; // { type, army, source, origin: {r,c} }

// Inicializar Agua
[[3,1], [1,3]].forEach(([r,c]) => {
    terrain[r][c] = 'water'; terrain[r][9-c] = 'water';
    terrain[9-r][c] = 'water'; terrain[9-r][9-c] = 'water';
});

// Inicializar Reservas
function init() {
    for(const [id, data] of Object.entries(CONFIG.pieces)) {
        reserves.rojo[id] = data.qty;
        reserves.negro[id] = data.qty;
    }
    updateStatus("Arrastra una Fortaleza al tablero para elegir bando");
    renderBoard();
    updateUI();
}

function getImgUrl(army, type) {
    const c = army === 'rojo' ? 'Rojo' : 'Negro';
    const files = {
        'fortaleza': 'Castillo.svg', 'montana': 'Montana.svg',
        'rey': 'Rey.svg', 'chusma': 'Chusma.svg', 'lanceros': 'Lanza.svg',
        'arqueros': 'Arco.svg', 'c_ligera': 'CaballeriaL.svg', 'c_pesada': 'CaballeriaP.svg',
        'elefante': 'Elefante.svg', 'escorpion': 'Escorpion.svg', 'trabuquete': 'Catapulta.svg',
        'dragon': 'Dragon.svg'
    };
    return `${CONFIG.repo}/${c}/${files[type]}`;
}

// --- RENDERIZADO DEL TABLERO ---
function renderBoard() {
    const b = document.getElementById('board');
    b.innerHTML = '';

    for(let r=0; r<10; r++) {
        for(let c=0; c<10; c++) {
            const tile = document.createElement('div');
            tile.className = `tile ${(r+c)%2===0?'light':'dark'}`;
            tile.dataset.r = r; tile.dataset.c = c;

            // 1. Agua
            if(terrain[r][c] === 'water') tile.classList.add('water');

            // 2. Fortalezas (Lógica 4 piezas)
            const fArmy = getFortressAt(r, c);
            if(fArmy) {
                // Niebla de guerra: ocultar si es P1 y estamos en turno P2
                let hide = (gameState === 'deploy-p2' && fArmy === p1Color);
                
                if(!hide) {
                    const fImg = document.createElement('img');
                    fImg.className = 'fortress-part';
                    fImg.src = getImgUrl(fArmy, 'fortaleza');
                    
                    // Lógica CLICK para terminar despliegue
                    if(gameState.startsWith('deploy') && fArmy === turn) {
                        // Solo activable si ya puso las montañas
                        if(reserves[turn].montana === 0) {
                            fImg.classList.add('deploy-clickable');
                            fImg.title = "Haz click para confirmar despliegue";
                            fImg.onclick = () => finishDeployPhase();
                        }
                    }
                    tile.appendChild(fImg);
                }
            }

            // 3. Montañas
            if(terrain[r][c] === 'mountain') {
                let hide = false;
                if(gameState === 'deploy-p2') {
                    // Ocultar las montañas de P1 (zona P1)
                    const p1North = fortresses[p1Color] ? fortresses[p1Color].r < 5 : (p1Color==='rojo'); // fallback
                    const isZoneP1 = p1North ? (r<5) : (r>=5);
                    if(isZoneP1) hide = true;
                }
                
                if(!hide) {
                    const m = document.createElement('img');
                    m.className = 'structure-img';
                    m.src = getImgUrl('rojo', 'montana'); // Genérica
                    tile.appendChild(m);
                }
            }

            // 4. Unidades
            const p = board[r][c];
            if(p) {
                // Niebla de guerra
                if(!(gameState === 'deploy-p2' && p.army === p1Color)) {
                    const img = document.createElement('img');
                    img.className = 'piece';
                    img.src = getImgUrl(p.army, p.type);
                    img.draggable = true;
                    img.ondragstart = (e) => handleDragStart(e, r, c);
                    if(p.type === 'chusma' && chusmaState.movedCount > 0 && chusmaState.lastId === p.id) {
                        img.style.filter = "grayscale(1)";
                    }
                    tile.appendChild(img);
                }
            }

            // Eventos
            tile.addEventListener('dragover', (e) => handleDragOver(e, r, c));
            tile.addEventListener('dragleave', (e) => handleDragLeave(e, r, c));
            tile.addEventListener('drop', (e) => handleDrop(e, r, c));
            tile.oncontextmenu = (e) => handleRightClick(e, r, c);
            
            b.appendChild(tile);
        }
    }
}

// --- ACTUALIZAR INTERFAZ ---
function updateUI() {
    ['rojo', 'negro'].forEach(army => {
        const panel = document.getElementById(`panel-${army}`);
        const list = document.getElementById(`inv-${army}`);
        list.innerHTML = '';
        
        let active = false;
        if(gameState === 'choose-color') active = true;
        else if(gameState === 'deploy-p1' && army === p1Color) active = true;
        else if(gameState === 'deploy-p2' && army !== p1Color) active = true;
        else if(gameState === 'playing' && turn === army) active = true;

        panel.className = `panel ${active ? 'active' : 'disabled'}`;

        for(const [type, count] of Object.entries(reserves[army])) {
            if(count > 0) {
                const item = document.createElement('div');
                item.className = 'inv-item';
                
                let locked = false;
                // En selección de color, solo fortalezas
                if(gameState === 'choose-color' && type !== 'fortaleza') locked = true;
                // En despliegue normal, fortaleza primero
                if(gameState.startsWith('deploy') && !fortresses[army] && type !== 'fortaleza') locked = true;
                
                if(locked) item.classList.add('locked');

                item.innerHTML = `<img src="${getImgUrl(army, type)}"><span class="count">${count}</span>`;
                
                if(!locked) {
                    item.draggable = true;
                    item.ondragstart = (e) => {
                        draggingMeta = { type, army, source: 'reserve' };
                        e.dataTransfer.setData('text/plain', JSON.stringify(draggingMeta));
                    };
                    item.ondragend = () => { draggingMeta = null; clearGhosts(); };
                }
                list.appendChild(item);
            }
        }
    });
}

function updateStatus(msg) { document.getElementById('status-bar').innerText = msg; }

// --- FUNCIONES AUXILIARES (SOLUCIÓN DEL BUG ANTERIOR) ---
function getFortressAt(r, c) {
    for(const army in fortresses) {
        const f = fortresses[army];
        // SEGURIDAD: Comprobar si f existe antes de leer f.r
        if(f && r >= f.r && r <= f.r+1 && c >= f.c && c <= f.c+1) return army;
    }
    return null;
}

function isSolid(r, c) { 
    if(r<0||r>9||c<0||c>9) return true;
    return terrain[r][c] === 'mountain'; 
}

function isRing(r, c, army) {
    const f = fortresses[army];
    if(!f) return false;
    return r>=f.r-1 && r<=f.r+2 && c>=f.c-1 && c<=f.c+2 && !getFortressAt(r,c);
}

// --- INTERACCIÓN (DRAG & DROP + GHOSTING) ---

function handleDragStart(e, r, c) {
    if(gameState === 'curtain') return;
    const p = board[r][c];
    if(!p) return;
    
    // Validación turno
    if(gameState.startsWith('deploy') && p.army !== turn) { e.preventDefault(); return; }
    if(gameState === 'playing' && p.army !== turn) { e.preventDefault(); return; }
    
    draggingMeta = { type: p.type, army: p.army, source: 'board', origin: {r, c} };
    e.dataTransfer.setData('text/plain', JSON.stringify(draggingMeta));
}

function handleDragOver(e, r, c) {
    e.preventDefault(); // Necesario para permitir Drop
    if(!draggingMeta) return;

    // GHOSTING: Calcular validez
    clearGhosts();
    const type = draggingMeta.type;
    let isValid = false;

    if(gameState.startsWith('deploy') || gameState === 'choose-color') {
        isValid = checkDeployValidity(type, r, c);
    } else if (gameState === 'playing') {
        // Validación simplificada visual
        const p = { type, army: draggingMeta.army };
        const origin = draggingMeta.origin;
        if(origin) isValid = !!validateMove(p, origin.r, origin.c, r, c, board[r][c]);
    }

    const css = isValid ? 'ghost-valid' : 'ghost-invalid';

    // Pintar área
    if(type === 'fortaleza') {
        // 2x2
        paintGhost(r, c, css);
        paintGhost(r+1, c, css);
        paintGhost(r, c+1, css);
        paintGhost(r+1, c+1, css);
    } else {
        paintGhost(r, c, css);
    }
}

function paintGhost(r, c, css) {
    const t = document.querySelector(`.tile[data-r="${r}"][data-c="${c}"]`);
    if(t) t.classList.add(css);
}

function clearGhosts() {
    document.querySelectorAll('.ghost-valid, .ghost-invalid').forEach(el => {
        el.classList.remove('ghost-valid', 'ghost-invalid');
    });
}

function handleDragLeave(e, r, c) {
    // Podríamos limpiar aquí, pero dragOver se encarga
}

function handleDrop(e, r, c) {
    e.preventDefault();
    clearGhosts();
    const dataTxt = e.dataTransfer.getData('text/plain');
    if(!dataTxt) return; 
    const data = JSON.parse(dataTxt);
    draggingMeta = null;

    if(data.source === 'reserve') {
        deployPiece(data.army, data.type, r, c);
    } else if (data.source === 'board') {
        movePiece(data.origin.r, data.origin.c, r, c);
    }
}

function handleRightClick(e, r, c) {
    e.preventDefault();
    if(gameState.startsWith('deploy')) {
        // Retirar unidad
        const p = board[r][c];
        if(p && p.army === turn) {
            board[r][c] = null;
            reserves[turn][p.type]++;
            renderBoard(); updateUI();
        }
        // Retirar montaña
        if(terrain[r][c] === 'mountain') {
            // Check propiedad zona
            const p1North = fortresses[p1Color] ? fortresses[p1Color].r < 5 : (r<5);
            const myZoneNorth = (turn === p1Color) ? p1North : !p1North;
            const clickNorth = r < 5;
            
            // Permisivo en despliegue: si está en mi zona, la quito
            if(clickNorth === myZoneNorth) {
                terrain[r][c] = null;
                reserves[turn].montana++;
                renderBoard(); updateUI();
            }
        }
    }
}

// --- LÓGICA DE VALIDACIÓN Y JUEGO ---

function checkDeployValidity(type, r, c) {
    const army = draggingMeta.army;
    
    // Fortaleza
    if(type === 'fortaleza') {
        if(r<=0 || r>=9 || c<=0 || c>=9) return false; // Margen borde
        if(r===4 || r===5) return false; // Margen centro
        if(isSolid(r,c) || isSolid(r+1,c) || isSolid(r,c+1) || isSolid(r+1,c+1)) return false;
        
        // Zona correcta
        if(gameState !== 'choose-color' && fortresses[p1Color]) {
            const p1North = fortresses[p1Color].r < 5;
            const myZoneNorth = (army === p1Color) ? p1North : !p1North;
            const clickNorth = r < 5;
            if(clickNorth !== myZoneNorth) return false;
        }
        return true;
    }

    // Montaña
    if(type === 'montana') {
        if(isSolid(r,c) || getFortressAt(r,c)) return false;
        if(fortresses[p1Color]) {
            const p1North = fortresses[p1Color].r < 5;
            const myZoneNorth = (army === p1Color) ? p1North : !p1North;
            if((r < 5) !== myZoneNorth) return false;
        }
        return true;
    }

    // Unidad
    if(!fortresses[army]) return false;
    if(!isRing(r, c, army)) return false;
    if(isSolid(r,c) || board[r][c]) return false;

    return true;
}

function deployPiece(army, type, r, c) {
    if(!checkDeployValidity(type, r, c)) return;

    // Elección Color
    if(gameState === 'choose-color') {
        p1Color = army;
        turn = army;
        fortresses[army] = {r, c};
        reserves[army].fortaleza--;
        gameState = 'deploy-p1';
        updateStatus(`Despliegue J1 (${army}). Montañas primero.`);
        renderBoard(); updateUI();
        return;
    }

    // Despliegue Normal
    if(type === 'fortaleza') {
        fortresses[army] = {r, c};
        reserves[army].fortaleza--;
    } else if (type === 'montana') {
        terrain[r][c] = 'mountain';
        reserves[army].montana--;
    } else {
        board[r][c] = { type, army, id: Date.now() + Math.random() };
        reserves[army][type]--;
    }
    renderBoard(); updateUI();
}

function finishDeployPhase() {
    if(gameState === 'deploy-p1') {
        gameState = 'curtain';
        document.getElementById('curtain').style.display = 'flex';
        updateStatus("Telón de Acero");
    } else if (gameState === 'deploy-p2') {
        gameState = 'playing';
        turn = 'rojo'; 
        updateStatus("¡BATALLA! Turno ROJO");
        renderBoard(); updateUI();
    }
}

function startPhase2() {
    gameState = 'deploy-p2';
    turn = (p1Color === 'rojo') ? 'negro' : 'rojo';
    document.getElementById('curtain').style.display = 'none';
    updateStatus(`Despliegue J2 (${turn}).`);
    renderBoard(); updateUI();
}

// MOVIMIENTO (Simplificado para brevedad, lógica completa anterior)
function movePiece(or, oc, tr, tc) {
    if(gameState.startsWith('deploy')) return;
    const p = board[or][oc];
    // Reset chusma si click mismo
    if(or===tr && oc===tc && p.type==='chusma' && chusmaState.movedCount>0) { endTurn(); return; }
    
    const target = board[tr][tc];
    const valid = validateMove(p, or, oc, tr, tc, target);

    if(valid) {
        if(valid === 'swap') { board[tr][tc]=p; board[or][oc]=target; }
        else if(valid === 'pierce') {
            const dr=Math.sign(tr-or), dc=Math.sign(tc-oc);
            let nr=tr-dr, nc=tc-dc;
            while(nr!==or) { if(board[nr][nc]) board[nr][nc]=null; nr-=dr; nc-=dc; }
            board[tr][tc]=null; 
            mazmorra[turn].push('escorpion_kill');
        } else if(valid === 'shoot') {
            board[tr][tc] = null;
        } else {
            board[tr][tc]=p; board[or][oc]=null;
        }

        // Chusma lógica extra
        if(p.type === 'chusma' && !target && valid===true) {
             chusmaState.movedCount++;
             chusmaState.lastId = p.id;
             let cCount = 0;
             for(let r of board) for(let pc of r) if(pc&&pc.army===turn&&pc.type==='chusma') cCount++;
             if(chusmaState.movedCount < 2 && cCount > 1) { renderBoard(); return; }
        }
        
        chusmaState = { movedCount: 0, lastId: null };
        endTurn();
    }
    renderBoard();
}

function validateMove(p, or, oc, tr, tc, target) {
    const dr=tr-or, dc=tc-oc;
    const absDr=Math.abs(dr), absDc=Math.abs(dc);
    
    if(isSolid(tr,tc) || getFortressAt(tr,tc)) return false;
    if(terrain[tr][tc]==='water' && p.type!=='dragon') return false;
    if(p.type==='dragon' && terrain[tr][tc]==='water') return false;

    // Validación básica por tipo (copia lógica anterior)
    switch(p.type) {
        case 'chusma': return absDr+absDc===1 && (!target || target.army!==p.army);
        case 'lanceros': return absDr+absDc===1; // Swap handleado arriba
        case 'rey': return Math.max(absDr,absDc)===1 && (!target || target.army!==p.army);
        case 'arqueros': 
            if(absDr!==absDc) return false;
            if(absDr===1) return true;
            if(absDr===2 && !board[or+dr/2][oc+dc/2] && !isSolid(or+dr/2,oc+dc/2)) return true;
            return false;
        case 'c_pesada': return (absDr===2 && absDc===1) || (absDr===1 && absDc===2);
        case 'c_ligera': return (absDr===3 && absDc===1) || (absDr===1 && absDc===3);
        case 'elefante': return (or===tr || oc===tc) && checkRay(or,oc,tr,tc,false);
        case 'dragon': return (or===tr||oc===tc||absDr===absDc) && checkRay(or,oc,tr,tc,true);
        case 'trabuquete': 
            if(absDr===1 && absDc===1 && !target) return true;
            if((or===tr||oc===tc) && target) return 'shoot';
            return false;
        case 'escorpion':
            if(absDr+absDc===1 && !target) return true;
            if(absDr===absDc && target) return 'shoot';
            return false;
    }
    return false;
}

function checkRay(r0,c0,r1,c1,fly) {
    const dr=Math.sign(r1-r0), dc=Math.sign(c1-c0);
    let r=r0+dr, c=c0+dc;
    while(r!==r1 || c!==c1) {
        if(isSolid(r,c) && (!fly || getFortressAt(r,c))) return false;
        if(board[r][c]) return false;
        r+=dr; c+=dc;
    }
    return true;
}

function endTurn() {
    turn = (turn==='rojo'?'negro':'rojo');
    updateStatus(`Turno ${turn.toUpperCase()}`);
    updateUI();
}

// ARRANQUE
init();
</script>
</body>
</html>
